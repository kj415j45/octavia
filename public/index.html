<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Octavia - 千星奇域工具</title>
    <meta name="name" itemprop="name" content="Octavia - 千星奇域工具" />
    <meta name="description" itemprop="description" content="Octavia，千星奇域工具，提供奇域查询功能。" />
    <meta name="keywords" content="Octavia, 欧科塔维亚, 千星奇域, 原神, Genshin, Genshin Impact, Miliastra Wonderland, miHoYo, 米哈游" />
    <meta itemprop="image" content="./lib/icon.png" />
    <link rel="icon" href="./favicon.ico" />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="./lib/bootstrap.min.css" />

    <link rel="stylesheet" href="./lib/font.css" />
</head>

<body class="d-flex flex-column min-vh-100">
    <header>
        <nav class="navbar bg-body-tertiary">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">欧科塔维亚</span>
                <select class="form-select w-auto" id="regionSelect">
                    <option selected disabled>选择服务器</option>
                </select>
            </div>
        </nav>
    </header>

    <div id="body" class="container-fluid d-flex flex-column justify-content-center align-items-center mt-auto mb-auto">
        <div id="search" class="text-center mt-4 col-10 col-md-8 col-lg-6">
            <form onsubmit="event.preventDefault(); loadStages(document.getElementById('stageIdsInput').value);"
                class="row g-2">
                <div class="col-8 col-md-10">
                    <input type="text" id="stageIdsInput" class="form-control" placeholder="输入奇域ID，支持自动识别" />
                </div>

                <div class="col-4 col-md-2">
                    <button type="submit" class="btn btn-primary w-100">查询</button>
                </div>

            </form>
        </div>
        <div id="stages" class="my-4 w-100">
            <!-- Stage cards will be appended here -->

        </div>
    </div>

    <footer class="mt-4">
        <p class="text-center">Source Code will be available Soon™️ on <a
                href="https://github.com/kj415j45/octavia">GitHub</a>
        </p>
        <p class="text-center">Powered by <a href="https://workers.cloudflare.com/">Cloudflare Workers</a></p>
    </footer>
    <!-- Bootstrap JS Bundle -->
    <script src="./lib/bootstrap.bundle.min.js"></script>
    <script>
        const currentUrl = new URL(window.location.href);
        const isLocalDebug = currentUrl.host.startsWith('127.0.0.1') || currentUrl.host.startsWith('localhost');
        const baseUrl = isLocalDebug ? `https://octavia.kj415j45.space` : "";
        const regionMap = {};
        var region = 'cn_gf01';

        const regionSelect = document.getElementById('regionSelect');
        regionSelect.addEventListener('change', (event) => {
            region = event.target.value;
            console.log(`Selected region: ${region}`);
        });

        async function getRegionMap() {
            const response = await fetch(`${baseUrl}/data/regions.json`);
            const regions = await response.json();
            for (const [id, info] of Object.entries(regions)) {
                regionMap[id] = info;
            }
        }
        // Populate the dropdown menu with regions
        async function populateRegionDropdown() {
            await getRegionMap(); // Ensure regionMap is populated
            //clear existing options
            const select = document.getElementById('regionSelect');
            select.innerHTML = '';

            for (const [id, data] of Object.entries(regionMap)) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = data.name;
                document.getElementById('regionSelect').appendChild(option);
            }

            // select the first by default
            if (select.options.length > 0) {
                select.options[0].selected = true;
                region = select.options[0].value;
            }
            const regionFromUrl = new URLSearchParams(window.location.search).get('region');
            if (regionFromUrl && regionMap[regionFromUrl]) {
                select.value = regionFromUrl;
                region = regionFromUrl;
            }
        }
        populateRegionDropdown();

        async function getStageInfo(region, id) {
            const response = await fetch(`${baseUrl}/api/stage?region=${region}&id=${id}`);
            return await response.json();
        }

        function makeStageCard(stage) {
            const level = stage.level;
            const meta = level.meta;
            const author = stage.author;

            // Create card container
            const card = document.createElement('div');
            // Ensure card body stretches to align footer at the bottom
            card.className = 'card h-100 mx-1';

            // Add preview image with click-to-fullscreen functionality
            const previewContainer = document.createElement('div');
            previewContainer.className = 'position-relative';

            const img = document.createElement('img');
            img.src = meta.cover.images[0];
            img.className = 'card-img-top';
            img.alt = meta.name;
            img.style.cursor = 'pointer';

            img.addEventListener('click', () => {
                // Create fullscreen overlay
                const overlay = document.createElement('div');
                overlay.className = 'fullscreen-overlay';
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                overlay.style.zIndex = '1050';
                overlay.style.display = 'flex';
                overlay.style.justifyContent = 'center';
                overlay.style.alignItems = 'center';

                // Create carousel for fullscreen preview
                const carousel = document.createElement('div');
                carousel.id = `carousel-${level.id}`;
                carousel.className = 'carousel slide';
                carousel.style.width = '80%';
                carousel.style.maxWidth = '800px';

                const carouselInner = document.createElement('div');
                carouselInner.className = 'carousel-inner';

                meta.cover.images.forEach((image, index) => {
                    const carouselItem = document.createElement('div');
                    carouselItem.className = `carousel-item${index === 0 ? ' active' : ''}`;

                    const img = document.createElement('img');
                    img.dataset.src = image; // Use data-src for lazy loading
                    img.className = 'd-block w-100 lazy'; // Add lazy class
                    img.alt = `${meta.name} - ${index + 1}`;

                    carouselItem.appendChild(img);
                    carouselInner.appendChild(carouselItem);
                });

                carousel.appendChild(carouselInner);

                // Add carousel controls
                const prevButton = document.createElement('button');
                prevButton.className = 'carousel-control-prev';
                prevButton.type = 'button';
                prevButton.setAttribute('data-bs-target', `#carousel-${level.id}`);
                prevButton.setAttribute('data-bs-slide', 'prev');
                prevButton.innerHTML = `
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                `;

                const nextButton = document.createElement('button');
                nextButton.className = 'carousel-control-next';
                nextButton.type = 'button';
                nextButton.setAttribute('data-bs-target', `#carousel-${level.id}`);
                nextButton.setAttribute('data-bs-slide', 'next');
                nextButton.innerHTML = `
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                `;

                carousel.appendChild(prevButton);
                carousel.appendChild(nextButton);

                // Close button for overlay
                const closeButton = document.createElement('button');
                closeButton.className = 'btn-close btn-close-white position-absolute top-0 end-0 m-3';
                closeButton.style.zIndex = '1060';
                closeButton.addEventListener('click', () => {
                    document.body.removeChild(overlay);
                });

                overlay.appendChild(carousel);
                overlay.appendChild(closeButton);
                document.body.appendChild(overlay);

                // Initialize Bootstrap carousel
                const bootstrapCarousel = new bootstrap.Carousel(carousel);

                // Initialize lazy loading after appending images
                const lazyImages = document.querySelectorAll('img.lazy');
                const observer = new IntersectionObserver((entries, obs) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src; // Set the actual src
                            img.classList.remove('lazy');
                            obs.unobserve(img);
                        }
                    });
                });

                lazyImages.forEach(img => observer.observe(img));
            });

            previewContainer.appendChild(img);
            card.appendChild(previewContainer);

            // Create card body
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body d-flex flex-column';

            // Add name and hot score/good rate
            const titleRow = document.createElement('div');
            titleRow.className = 'd-flex justify-content-between align-items-center';

            const name = document.createElement('h5');
            name.className = 'card-title';
            name.textContent = meta.name;
            titleRow.appendChild(name);

            const stats = document.createElement('small');
            stats.className = 'text-muted';
            stats.textContent = `${meta.hotScore} | ${meta.goodRate}`;
            titleRow.appendChild(stats);

            cardBody.appendChild(titleRow);

            const textContainer = document.createElement('ul');
            textContainer.className = 'list-group';

            // Add intro
            const intro = document.createElement('li');
            intro.className = 'list-group-item';
            intro.innerHTML = meta.intro.replace(/\n/g, '<br>');
            intro.style.height = '6em'; // Set fixed height
            intro.style.overflowY = 'auto'; // Enable vertical scrolling
            textContainer.appendChild(intro);

            // Add description
            const description = document.createElement('li');
            description.className = 'list-group-item';
            description.innerHTML = meta.description.replace(/\n/g, '<br>');
            description.style.height = '8em'; // Set fixed height
            description.style.overflowY = 'auto'; // Enable vertical scrolling
            textContainer.appendChild(description);

            cardBody.appendChild(textContainer);

            // Add tags as badges
            const tagsContainer = document.createElement('div');
            tagsContainer.className = 'd-flex justify-content-between my-2 row';

            const leftTags = document.createElement('div');
            leftTags.className = 'col-6';
            const playerNumTag = document.createElement('span');
            playerNumTag.className = 'badge me-1';
            if (meta.players.str.startsWith('1')) {
                if (meta.players.str.startsWith('1-')) {
                    playerNumTag.classList.add('bg-info');
                } else {
                    playerNumTag.classList.add('bg-success');
                }
            } else {
                playerNumTag.classList.add('bg-warning');
            }
            playerNumTag.textContent = `[${meta.players.min}, ${meta.players.max}] ${meta.players.str}人`;
            [meta.type, meta.category].forEach(tag => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-secondary me-1';
                badge.textContent = tag;
                leftTags.appendChild(badge);
            });
            leftTags.appendChild(document.createElement('br')); // Spacer
            leftTags.appendChild(playerNumTag);


            const rightTags = document.createElement('div');
            rightTags.className = 'col-6 text-end';
            meta.tags.forEach(tag => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary me-1';
                badge.textContent = tag;
                rightTags.appendChild(badge);
            });

            tagsContainer.appendChild(leftTags);
            tagsContainer.appendChild(rightTags);
            cardBody.appendChild(tagsContainer);

            // Add author and level ID section
            const footer = document.createElement('div');
            // Adjust footer to stick to the bottom
            footer.className = 'card-footer mt-auto d-flex justify-content-between align-items-center';

            // Author info
            const authorInfo = document.createElement('div');
            authorInfo.className = 'd-flex align-items-center';

            const avatar = document.createElement('img');
            avatar.src = author.game.avatar;
            avatar.alt = author.game.name;
            avatar.className = 'rounded-circle me-2';
            avatar.style.width = '40px';
            avatar.style.height = '40px';

            const authorName = document.createElement('span');
            authorName.textContent = author.game.name;

            authorInfo.appendChild(avatar);
            authorInfo.appendChild(authorName);

            // Level ID and copy button
            const levelInfo = document.createElement('div');
            levelInfo.className = 'd-flex align-items-center';

            const levelId = document.createElement('span');
            levelId.className = 'me-2';
            levelId.textContent = `${level.id}`;

            const copyButton = document.createElement('button');
            copyButton.className = 'btn btn-sm btn-outline-secondary';
            copyButton.textContent = '复制';
            copyButton.addEventListener('click', () => {
                navigator.clipboard.writeText(level.id);
                copyButton.textContent = '已复制';
                copyButton.classList.remove('btn-outline-secondary');
                copyButton.classList.add('btn-success');
                setTimeout(() => {
                    copyButton.textContent = '复制';
                    copyButton.classList.remove('btn-success');
                    copyButton.classList.add('btn-outline-secondary');
                }, 2000); // Revert after 2 seconds
            });

            levelInfo.appendChild(levelId);
            levelInfo.appendChild(copyButton);

            footer.appendChild(authorInfo);
            footer.appendChild(levelInfo);
            cardBody.appendChild(footer);

            card.appendChild(cardBody);

            return card;
        }

        async function loadStages(stageIdsString) {
            const pattern = /\d+/g;
            const matches = stageIdsString.match(pattern);
            stageIds = matches || [];

            stageIds = [...new Set(stageIds)];

            const stageIdInput = document.getElementById('stageIdsInput');
            const stages = (await Promise.all(stageIds.map(id => getStageInfo(region, id).catch(err => null)))).filter(stage => stage && stage.level);
            if (stages.length === 0) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.textContent = '请输入至少一个有效的奇域ID！';
                const stagesDiv = document.getElementById('stages');
                stagesDiv.innerHTML = '';
                stagesDiv.appendChild(errorDiv);
                return;
            }
            const levelIds = stages.map(stage => stage.level.id);
            stageIdInput.value = levelIds.join(', ');
            window.history.replaceState(null, '', `?stages=${levelIds.join(',')}&region=${region}`);

            const stageCards = stages.map(stage => makeStageCard(stage));

            const stagesDiv = document.getElementById('stages');
            stagesDiv.innerHTML = '';
            const masonryContainer = document.createElement('div');
            masonryContainer.className = 'row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4';
            stageCards.forEach(card => {
                const col = document.createElement('div');
                col.className = 'col d-flex justify-content-center';
                col.appendChild(card);
                masonryContainer.appendChild(col);
            });
            stagesDiv.appendChild(masonryContainer);

        }
        const query = new URLSearchParams(window.location.search);
        const stageIdsParam = query.get('stages');
        if (stageIdsParam) {
            loadStages(stageIdsParam);
        }

    </script>
</body>

</html>