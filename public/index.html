<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Octavia - 千星奇域工具</title>
    <meta name="name" itemprop="name" content="Octavia - 千星奇域工具" />
    <meta name="description" itemprop="description" content="Octavia，千星奇域工具，提供奇域查询功能。" />
    <meta name="keywords"
        content="Octavia, 欧科塔维亚, 千星奇域, 原神, Genshin, Genshin Impact, Miliastra Wonderland, miHoYo, 米哈游" />
    <meta itemprop="image" content="/lib/icon.png" />
    <link rel="icon" href="/favicon.ico" />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/lib/bootstrap.min.css" />

    <link rel="stylesheet" href="/lib/font.css" />
</head>

<body class="d-flex flex-column min-vh-100">
    <header>
        <nav class="navbar bg-body-tertiary">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">欧科塔维亚</span>
                <select class="form-select w-auto" id="regionSelect">
                    <option selected disabled>选择服务器</option>
                </select>
            </div>
        </nav>
    </header>

    <div id="body" class="container-fluid d-flex flex-column justify-content-center align-items-center mt-auto mb-auto">
        <div id="search" class="text-center my-4 col-10 col-md-8 col-lg-6">
            <form onsubmit="handleSubmit(event)"
                class="row g-2">
                <div class="col-8 col-md-10">
                    <input type="text" id="stageIdsInput" class="form-control" placeholder="输入奇域ID，支持自动识别" />
                </div>

                <div class="col-4 col-md-2">
                    <button type="submit" class="btn btn-primary w-100">查询</button>
                </div>

            </form>
        </div>
        <div id="hints" class="row my-2 text-center justify-content-center col-10 col-md-8 col-lg-6">
            <!-- Hints and messages will be appended here -->

        </div>
        <div id="stages" class="my-2 w-100">
            <!-- Stage cards will be appended here -->

        </div>
    </div>

    <footer class="mt-4">
        <p class="text-center">Source Code is available on <a href="https://github.com/kj415j45/octavia">GitHub</a></p>
        <p class="text-center">Powered by <a href="https://workers.cloudflare.com/">Cloudflare Workers</a></p>
    </footer>
    <!-- Bootstrap JS Bundle -->
    <script src="/lib/bootstrap.bundle.min.js"></script>
    <!-- Common utilities -->
    <script src="/lib/common.js"></script>
    <script>
        var region = 'cn_gf01';

        const regionSelect = document.getElementById('regionSelect');
        regionSelect.addEventListener('change', (event) => {
            updateRegion(event.target.value);
        });

        function updateRegion(newRegion) {
            if (regionMap[newRegion]) {
                region = newRegion;
                regionSelect.value = newRegion;
                console.log(`Region updated to: ${region}`);
            } else {
                console.warn(`Region ${newRegion} not found in regionMap.`);
            }
        }

        async function initPage() {
            const initialRegion = await populateRegionDropdown(region);
            if (initialRegion) {
                region = initialRegion;
                updateRegion(region);
            }
            
            // Check URL params after initialization
            const query = new URLSearchParams(window.location.search);
            const stageIdsParam = query.get('stages');
            if (stageIdsParam) {
                loadStages(stageIdsParam);
            }
        }

        async function loadStages(stageIdsString) {
            // Clean up
            $Stages.length = 0;
            document.getElementById('copyExcelButton')?.remove();

            const pattern = /\d+/g;
            const matches = stageIdsString.match(pattern);
            let stageIds = matches || [];

            stageIds = [...new Set(stageIds)];

            const stageIdInput = document.getElementById('stageIdsInput');
            const stagesDiv = document.getElementById('stages');
            stagesDiv.innerHTML = ''; // Clear previous content

            const validStageIds = []

            for (const id of stageIds) {
                try {
                    const stage = await getStageInfo(region, id);
                    if (stage && stage.level) {
                        const levelId = stage.level.id;
                        validStageIds.push(levelId);

                        const stageCard = makeStageCard(stage, region);
                        const col = document.createElement('div');
                        col.className = 'col d-flex justify-content-center';
                        col.appendChild(stageCard);

                        let masonryContainer = stagesDiv.querySelector('.row');
                        if (!masonryContainer) {
                            masonryContainer = document.createElement('div');
                            masonryContainer.className = 'row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4';
                            stagesDiv.appendChild(masonryContainer);
                        }
                        masonryContainer.appendChild(col);
                    }
                } catch (err) {
                    console.error(`Failed to load stage with ID ${id}:`, err);
                }
            }

            const csText = validStageIds.join(', ');
            stageIdInput.value = csText;
            window.history.replaceState(null, '', `?stages=${csText.replace(/ /g, '')}&region=${region}`);
            const sha256Hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(csText));
            const hashArray = Array.from(new Uint8Array(sha256Hash));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            console.log(`SHA-256 Hash of stage IDs: ${hashHex}`);

            const hintsDiv = document.getElementById('hints');
            hintsDiv.innerHTML = '';
            if (!stagesDiv.querySelector('.row')) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.textContent = '请输入至少一个有效的奇域ID！';
                hintsDiv.appendChild(errorDiv);
            } else {
                // add copy as excel button before the stages
                const copyExcelButton = document.createElement('button');
                copyExcelButton.id = 'copyExcelButton';
                copyExcelButton.className = 'btn btn-success mb-3 justify-content-center col-md-6 col-lg-4 d-none d-md-block';
                copyExcelButton.textContent = '复制为 Excel 格式';
                const copyText = $Stages.map(e => 
                    `${e.level.id}\t${e.level.meta.name}\t${e.level.meta.players.str}`
                ).join('\n');
                copyExcelButton.addEventListener('click', () => {
                    navigator.clipboard.writeText(copyText);
                    copyExcelButton.textContent = '已复制';
                    setTimeout(() => {
                        copyExcelButton.textContent = '复制为 Excel 格式';
                    }, 2000);
                });
                hintsDiv.appendChild(copyExcelButton);

                await loadBonusMessage(hashHex);
            }
        }

        async function handleSubmit(event){
            event.preventDefault();
            const input = document.getElementById('stageIdsInput').value;
            const hintsDiv = document.getElementById('hints');
            if(input.length <= 20){
                const bonusMessage = document.querySelector('.bonus-message');
                if(bonusMessage){
                    bonusMessage.remove();
                }
                const message = await loadBonusMessage(input);
                if(message != null && message != '') return;
            }
            await loadStages(input);
        }

        async function getBonusMessage(hash) {
            const response = await fetch(`${baseUrl}/api/bonus?hash=${hash}`);
            return await response.text();
        }

        async function loadBonusMessage(hash) {
            try {
                var message = await getBonusMessage(hash);
                if (message) {
                    if(message.includes('http://') || message.includes('https://')) {
                        const urlPattern = /(https?:\/\/[^\s]+)/g;
                        message = message.replace(urlPattern, function(url) {
                            return `<a href="${url}" target="_blank" rel="noopener">${url}</a>`;
                        });
                    }
                    const hintsDiv = document.getElementById('hints');
                    const bonusDiv = document.createElement('div');
                    bonusDiv.className = 'alert alert-info bonus-message';
                    bonusDiv.innerHTML = message;
                    hintsDiv.appendChild(bonusDiv);
                }
                return message;
            } catch (err) {
                return null;
            }
        }

        // Initialize page
        initPage();

    </script>

    <!-- Dev Tools -->
    <script src="/lib/lodash.min.js" defer></script>
    <script>
        console.log('%c Welcome to Octavia!\n%c Loaded stages can be found in $Stages\n%c Lodash 4.17.21 is globally available as _', 'background: #222; color: #bada55; font-size: 16px;', 'background: #222; color: #bada55; font-size: 12px;', 'background: #222; color: #bada55; font-size: 12px;');
    </script>
</body>

</html>