<!DOCTYPE html>
<html lang="zh" data-bs-theme="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>状态 - Octavia</title>
    <meta name="name" itemprop="name" content="状态 - Octavia" />
    <meta name="description" itemprop="description" content="Octavia，千星奇域工具，提供奇域查询功能。" />
    <meta name="keywords"
        content="Octavia, 欧科塔维亚, 千星奇域, 原神, Genshin, Genshin Impact, Miliastra Wonderland, miHoYo, 米哈游" />
    <meta itemprop="image" content="./lib/icon.png" />
    <link rel="icon" href="./favicon.ico" />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="./lib/bootstrap.min.css" />

    <link rel="stylesheet" href="./lib/font.css" />
</head>

<body class="d-flex flex-column min-vh-100">
    <header>
        <nav class="navbar bg-body-tertiary">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">欧科塔维亚 - 运行状态</span>
            </div>
        </nav>
    </header>

    <div id="body" class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">最近24小时运行状态</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="card-title text-muted">当前最快响应</h6>
                        <h2 class="text-success">
                            <span id="currentMin">--</span>
                            <span id="minTrend"></span>
                        </h2>
                        <small class="text-muted">
                            毫秒
                            <div id="minAvg" class="mt-1"></div>
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="card-title text-muted">当前最慢响应</h6>
                        <h2 class="text-danger">
                            <span id="currentMax">--</span>
                            <span id="maxTrend"></span>
                        </h2>
                        <small class="text-muted">
                            毫秒
                            <div id="maxAvg" class="mt-1"></div>
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="card-title text-muted">当前平均响应</h6>
                        <h2 class="text-primary">
                            <span id="currentAvg">--</span>
                            <span id="avgTrend"></span>
                        </h2>
                        <small class="text-muted">
                            毫秒
                            <div id="avgAvgValue" class="mt-1"></div>
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="card-title text-muted">当前成功率</h6>
                        <h2 class="text-info">
                            <span id="currentSuccessRate">--</span>
                            <span id="successRateTrend"></span>
                        </h2>
                        <small class="text-muted">
                            %
                            <div id="successRateAvg" class="mt-1"></div>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-4">
        <p class="text-center">Source Code is available on <a href="https://github.com/kj415j45/octavia">GitHub</a></p>
        <p class="text-center">Powered by <a href="https://workers.cloudflare.com/">Cloudflare Workers</a></p>
    </footer>
    <!-- Bootstrap JS Bundle -->
    <script src="./lib/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="./lib/chart.umd.min.js"></script>
    
    <script>
        // 获取状态数据并绘制图表
        async function loadStatusData() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    throw new Error('Failed to fetch status data');
                }
                
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    console.warn('No data available');
                    return;
                }
                
                // 数据从API返回时是降序（最新在前），需要反转为升序以便图表从左（过去）到右（现在）显示
                data.reverse();
                
                // 提取数据
                const labels = data.map(point => {
                    const date = new Date(point.timestamp);
                    return date.toLocaleString('zh-CN', { 
                        month: 'numeric', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                });
                
                const minData = data.map(point => point.minDuration);
                const maxData = data.map(point => point.maxDuration);
                const avgData = data.map(point => point.avgDuration);
                const successRateData = data.map(point => point.successRate * 100); // 转换为百分比
                
                // 更新当前值（使用最新的数据点）
                const latest = data[data.length - 1];
                const previous = data.length > 1 ? data[data.length - 2] : null;
                
                // 计算24小时平均值
                const calc24hAvg = (dataPoints, field) => {
                    const sum = dataPoints.reduce((acc, point) => acc + point[field], 0);
                    return sum / dataPoints.length;
                };
                
                const avg24hMin = calc24hAvg(data, 'minDuration');
                const avg24hMax = calc24hAvg(data, 'maxDuration');
                const avg24hAvg = calc24hAvg(data, 'avgDuration');
                const avg24hSuccessRate = calc24hAvg(data, 'successRate');
                
                // 生成趋势箭头
                const getTrendArrow = (current, previous) => {
                    if (!previous) return '';
                    if (current > previous) return '↑ ';
                    if (current < previous) return '↓ ';
                    return '→ ';
                };
                
                // 成功率的趋势相反（越高越好）
                const getSuccessRateTrendArrow = (current, previous) => {
                    if (!previous) return '';
                    if (current > previous) return '↑ ';
                    if (current < previous) return '↓ ';
                    return '→ ';
                };
                
                // 更新最快响应
                document.getElementById('currentMin').textContent = Math.round(latest.minDuration);
                document.getElementById('minTrend').textContent = getTrendArrow(
                    latest.minDuration, 
                    previous ? previous.minDuration : null
                );
                document.getElementById('minAvg').textContent = `(24h平均: ${Math.round(avg24hMin)}ms)`;
                
                // 更新最慢响应
                document.getElementById('currentMax').textContent = Math.round(latest.maxDuration);
                document.getElementById('maxTrend').textContent = getTrendArrow(
                    latest.maxDuration, 
                    previous ? previous.maxDuration : null
                );
                document.getElementById('maxAvg').textContent = `(24h平均: ${Math.round(avg24hMax)}ms)`;
                
                // 更新平均响应
                document.getElementById('currentAvg').textContent = Math.round(latest.avgDuration);
                document.getElementById('avgTrend').textContent = getTrendArrow(
                    latest.avgDuration, 
                    previous ? previous.avgDuration : null
                );
                document.getElementById('avgAvgValue').textContent = `(24h平均: ${Math.round(avg24hAvg)}ms)`;
                
                // 更新成功率
                document.getElementById('currentSuccessRate').textContent = (latest.successRate * 100).toFixed(2);
                document.getElementById('successRateTrend').textContent = getSuccessRateTrendArrow(
                    latest.successRate, 
                    previous ? previous.successRate : null
                );
                document.getElementById('successRateAvg').textContent = `(24h平均: ${(avg24hSuccessRate * 100).toFixed(2)}%)`;
                
                // 创建图表
                const ctx = document.getElementById('statusChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '最快响应',
                                data: minData,
                                borderColor: 'rgb(25, 135, 84)',
                                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                                tension: 0.3,
                                fill: false
                            },
                            {
                                label: '平均响应',
                                data: avgData,
                                borderColor: 'rgb(13, 110, 253)',
                                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                tension: 0.3,
                                fill: false
                            },
                            {
                                label: '最慢响应',
                                data: maxData,
                                borderColor: 'rgb(220, 53, 69)',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                tension: 0.3,
                                fill: false
                            },
                            {
                                label: '成功率',
                                data: successRateData,
                                borderColor: 'rgb(13, 202, 240)',
                                backgroundColor: 'rgba(13, 202, 240, 0.1)',
                                borderDash: [5, 5],
                                tension: 0.3,
                                fill: false,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.dataset.label === '成功率') {
                                            label += context.parsed.y.toFixed(2) + ' %';
                                        } else {
                                            label += Math.round(context.parsed.y) + ' ms';
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: '时间'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    autoSkip: true,
                                    maxTicksLimit: 20,
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '响应时间 (ms)'
                                },
                                beginAtZero: true,
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '成功率 (%)'
                                },
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error loading status data:', error);
                document.getElementById('body').innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <h4 class="alert-heading">加载失败</h4>
                        <p>无法加载状态数据，请稍后重试。</p>
                        <hr>
                        <p class="mb-0">错误信息: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // 页面加载时获取数据
        document.addEventListener('DOMContentLoaded', loadStatusData);
    </script>

</body>

</html>
